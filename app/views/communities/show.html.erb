<h2>Community Details</h2>

<h1><%= @community.title %></h1>

<% if @community.user == current_user %>
<p><strong><span style="color: red;">You are the owner of this community.</span></strong></p>
<% else %>
  <p>
    <%= @community.is_public? ? 'Public' : 'Private' %>
    <span class="">
      <b>
        <% status = user_community_status(@community, current_user) %>
        <% if status == 'Join' %>
          <%= form_for @join_request, url: community_community_join_requests_path(@community), method: :post do |f| %>
            <%= f.submit status, class: "btn btn-outline-dark" %>
          <% end %>
        <% else %>
          <button class="btn btn-outline-<%= status == 'Joined' ? 'success' : 'dark' %>" disabled><%= status %></button>
        <% end %>
      </b>
    </span>
  </p>
<% end %>



<hr>

<ul>
  <li><%= @community.description %></li>

  <% if @community.photos.attached? %>
    <% @community.photos.each do |photo| %>
      <%= cl_image_tag photo.key, class: "img-thumbnail", width: 200, crop: :thumb %>
    <% end %>
  <% end %>

  <li><%= @community.category %></li>
  <li><%= @community.country %></li>
  <li><%= @community.city %></li>
  <li>Is public? <%= @community.is_public %></li>
  <li>Is visible? <%= @community.is_visible %></li>
</ul>

<hr>

<h2>Events:</h2>
<div class="row">
  <% @events.each do |event| %>
    <div class="col-lg-3 my-3">
      <div class="card" style="width: 18rem; height: 22rem;">
        <div class="card-body position-relative">
          <h5 class="card-title"><%= event.title %></h5>
          <h6 class="card-subtitle mb-2 text-muted"></h6>
          <p class="card-text" style="position: absolute; bottom: 0; left: 0; margin: 8px;"><%= event.description %></p>
          <div class="d-flex justify-content-center" style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);">
            <%= event.capacity %>
          </div>
          <%= link_to "Details", community_event_path(@community, event), class: "btn btn-outline-dark position-absolute bottom-0 end-0 m-2" %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<% if @community.user == current_user %>
  <hr>
  <h2><b>Admin panel:</b></h2>
  <h3>Community settings</h3>

  <ul>
 <% if policy(@community).new? %>
  <li>   <%= link_to "Create Event", new_community_event_path(@community) %> </li>
  <% end %>

  <% if policy(@community).edit? %>
  <li> <%= link_to "Edit my community", edit_community_path(@community) %> </li>
  <% end %>

  <% if policy(@community).destroy? %>
   <li> <%= link_to "Delete my community", community_path(@community), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" } %> </li>
  <% end %>
</ul>

<% end %>


 <% unless @community.is_public? %>

  <h3>Members requests: </h3>


<%# inserting a table to view user requests%>
<table class="table">
  <thead class="thead-dark">
    <tr>
      <th scope="col">#</th>
      <th scope="col">User ID</th>
      <th scope="col">First name</th>
      <th scope="col">Last name</th>
      <th scope="col">Instagram Handle</th>
      <th scope="col">Request status</th>
      <th scope="col">Decision</th>
    </tr>
  </thead>
  <tbody>
      <% @community.pending_community_join_requests.each_with_index do |jr, index| %>
    <tr>
      <td><%= index + 1 %></td>
      <td><%= jr.user_id %></td>
      <td><%= jr.user.first_name %></td>
      <td><%= jr.user.last_name %></td>
      <td><%= jr.user.instagram_handle %></td>
      <td><%= jr.status %></td>
      <td>
        <%=  link_to "Accept", community_community_join_request_path(@community, jr, status: "accepted"), data: {turbo_method: :patch},
        class: jr.status == "accepted" ? "btn btn-success disabled" : "btn btn-success" %>

        <%= link_to "Reject", community_community_join_request_path(@community, jr, status: "rejected"), data: {turbo_method: :patch}, class: "btn btn-danger"%>
    <% end %>
        </tr>
  </tbody>
</table>

<% end %>

  <h3>Community members</h3>

<table class="table">
  <thead class="table-success">
    <tr>
      <th scope="col">#</th>
      <th scope="col">User ID</th>
      <th scope="col">First name</th>
      <th scope="col">Last name</th>
      <th scope="col">Instagram Handle</th>

    </tr>
  </thead>

  <tbody>
  <% @community.community_users.each_with_index do |c, index| %>
    <tr>
      <td><%= index + 1 %></td>
      <td><%= c.user_id %></td>
      <td><%= c.user.first_name %></td>
      <td><%= c.user.last_name %></td>
      <td><%= c.user.email %></td>


      <td><%= c.user.instagram_handle %></td>


  <% end %>


<hr>
<%= link_to "Back", communities_path %>
