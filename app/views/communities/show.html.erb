<center>
  <% if @community.user == current_user || (current_user && current_user.is_moderator_of?(@community)) || (current_user && current_user.admin) %>
    Hi <%= current_user.first_name %>, you are viewing this module since you are
    <% if current_user.admin  %>
      an admin of the platform.
    <% elsif @community.user == current_user %>
      the owner of this community (<%= @community.title %>).
    <% elsif current_user.is_moderator_of?(@community) %>
      a moderator  of this community (<%= @community.title %>).
    <% end %>
  <% end %>
</center>
<% if @community.user == current_user || (current_user && current_user.is_moderator_of?(@community)) || (current_user && current_user.admin) %>
  <div class="container">
    <div class="row">
      <div class="col-sm-4 mt-4">
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">Community dashboard</h5>
            <p class="card-text">
              <li> Manage join membership requests<br>
                <li> View users history<br>
                  <li> Set moderator permissions<br>
                    <%= link_to "Go to the community dashboard", dashboard_path(@community), class: "btn btn-outline-dark" %>
                  </p>
                </div>
              </div>
            </div>
            <% if current_user.admin || @community.user == current_user  %>
              <div class="col-sm-4 mt-4">
                <div class="card mb-4">
                  <div class="card-body">
                    <h5 class="card-title">Community settings</h5>
                    <p class="card-text text-center">
                      <% if policy(@community).new? %>
                        <%= link_to "Create Event", new_community_event_path(@community), class: "btn btn-outline-primary" %></li>
                      <br>
                    <% end %>
                    <% if policy(@community).edit? %>
                      <%= link_to "Edit my community", edit_community_path(@community), class: "btn btn-outline-warning" %></li>
                    <br>
                  <% end %>
                  <% if policy(@community).destroy? %>
                    <%= link_to "Delete my community", community_path(@community), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, class: "btn btn-outline-danger" %></li>
                  <br>
                <% end %>
              </p>
            </div>
          </div>
        <% end %>
      </div>
      <div class="col-sm-4 mt-4">
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">Community stats</h5>
            <p class="card-text">
              Members in community : <%= @community.users.count %><br>
              Since this week: <%= @community.community_users.where("created_at > ?", Date.current.beginning_of_week).count %> <br>
              Events created: <%= @community.events.count %>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>
<hr>
<h1><%= @community.title %></h1>
<p>
  <%= @community.public? ? 'This community is public' : 'This community is private' %><br>
  <span class="">
    <% status = user_community_status(@community, current_user) %>
    <% if status == 'Join' %>
      <%= form_for @join_request, url: community_community_join_requests_path(@community), method: :post do |f| %>
        <%= f.submit status, class: "btn btn-outline-dark" %>
      <% end %>
    <% else %>
      <i><%= status %></i>
    <% end %>
  </b>
</span>
</p>
<hr>
<ul>
  <li><%= @community.description %></li>
  <% if @community.photos.attached? %>
    <% @community.photos.each do |photo| %>
      <%= cl_image_tag photo.key, class: "img-thumbnail", width: 200, crop: :thumb %>
    <% end %>
  <% end %>
  <li><%= @community.category %></li>
  <li><%= @community.country %></li>
  <li><%= @community.city %></li>
  <li>Is public? <%= @community.public %></li>
  <li>Is visible? <%= @community.is_visible %></li>
</ul>
<hr>
<h2>Events:</h2>
<% if @community.user == current_user || (current_user && current_user.is_moderator_of?(@community)) || (current_user && current_user.admin) %>
  <% if @community.events.present? %>
    <div class="btn-group">
      <button type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
        Event dashboad quick access
      </button>
      <ul class="dropdown-menu">
        <% @community.events.last(5).each do |event| %>
          <li> <%= link_to event.title, event_dashboard_path(@community, event), class: "dropdown-item" %> </li>
        <% end %>
      </ul>
    </div>
  <% end %>
<% end %>
<% unless @community.public? %>
  <% if @community.user == current_user || (current_user && current_user.is_moderator_of?(@community)) || (current_user && current_user.is_member_of?(@community)) || (current_user && current_user.admin) %>
    <% if @community.events.present? %>
      <div class="row">
        <% @community.events.each do |event| %>
          <div class="col-lg-3 my-3">
            <div class="card" style="width: 18rem; height: 22rem;">
              <div class="card-body position-relative">
                <h5 class="card-title"><%= event.title %></h5>
                <h6 class="card-subtitle mb-2 text-muted"></h6>
                <p class="card-text" style="position: absolute; bottom: 0; left: 0; margin: 8px;"><%= event.description %></p>
                <div class="d-flex justify-content-center" style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);">
                  <%= event.capacity %>
                </div>
                <%= link_to "Details", community_event_path(@community, event), class: "btn btn-outline-dark position-absolute bottom-0 end-0 m-2" %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      There are no events in this community yet.
    <% end %>
  <% else %>
    You must request to join and be accepted in the <%= @community.title %> community to see the events.
  <% end %>
<% else %>
  <% if @community.events.present? %>
    <div class="row">
      <% @community.events.each do |event| %>
        <div class="col-lg-3 my-3">
          <div class="card" style="width: 18rem; height: 22rem;">
            <div class="card-body position-relative">
              <h5 class="card-title"><%= event.title %></h5>
              <h6 class="card-subtitle mb-2 text-muted"></h6>
              <p class="card-text" style="position: absolute; bottom: 0; left: 0; margin: 8px;"><%= event.description %></p>
              <div class="d-flex justify-content-center" style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);">
                <%= event.capacity %>
              </div>
              <%= link_to "Details", community_event_path(@community, event), class: "btn btn-outline-dark position-absolute bottom-0 end-0 m-2" %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    There are no events in this community yet.
  <% end %>
<% end %>
</ul>
<hr>
<%= link_to "Back", communities_path %>
